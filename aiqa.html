<!DOCTYPE html>
<!-- 页面：AI 问答（轨道交通运营管理课程） -->
<!-- 结构：导航栏 / 左侧设置与历史 / 右侧聊天区 / 底部输入区 -->
<!-- 功能：Markdown 渲染、代码高亮、TeX 公式、话题管理、消息工具栏 -->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI 问答 - 轨道交通运营管理课程</title>
    <style>
        /* --- 全局样式 (继承自 index.html) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f9f9f9;
            height: 100vh; /* 充满视口 */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* 禁止body滚动 */
        }

        /* 导航栏 */
        nav {
            background-color: #2c3e50;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0; /* 防止导航栏被压缩 */
            z-index: 100;
        }
        nav ul { list-style: none; display: flex; align-items: center; }
        nav ul li { margin-right: 20px; }
        nav ul li a {
            color: white; text-decoration: none; padding: 8px 12px; border-radius: 4px;
            transition: background-color 0.3s;
            display: inline-flex; align-items: center; /* 保证文字垂直居中 */
        }
        nav ul li a:hover, nav ul li a.active { background-color: #34495e; color: #f1c40f; }
        .nav-right { margin-left: auto; }
        .user-info { display: none; }
        .user-info.active { display: block; }

        /* --- 布局容器 --- */
        .qa-container {
            display: flex;
            flex: 1; /* 占据剩余高度 */
            overflow: hidden;
        }

        /* --- 左侧边栏 --- */
        .sidebar {
            width: 300px;
            background-color: #ffffff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar-section { margin-bottom: 30px; }
        .sidebar-section h3 {
            font-size: 1.1rem; color: #2c3e50; border-bottom: 2px solid #f1c40f;
            padding-bottom: 5px; margin-bottom: 15px; display: inline-block;
        }

        .setting-item label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        .setting-item input {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
            font-family: monospace; font-size: 0.85rem; color: #555;
        }

        /* 历史列表 */
        .history-list { list-style: none; }
        .history-list li {
            padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer;
            transition: background 0.2s; border-radius: 4px;
        }
        .history-list li:hover { background-color: #f5f5f5; }
        .history-list li.active { background-color: #e9f5ff; border-left: 3px solid #f1c40f; }
        .history-list .date { font-size: 0.75rem; color: #999; display: block; }
        .history-list .topic { font-size: 0.9rem; font-weight: 500; color: #333; }

        /* --- 右侧聊天区 --- */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #f4f6f8;
            position: relative;
        }

        /* 聊天记录滚动区 */
        .chat-log {
            flex: 1;
            overflow-y: auto;
            padding: 20px 40px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        /* 消息气泡 */
        .message { display: flex; max-width: 85%; }
        .message.user { align-self: flex-end; flex-direction: row-reverse; }
        .message.ai { align-self: flex-start; }

        .avatar {
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.8rem; flex-shrink: 0;
            color: white;
        }
        .message.user .avatar { background-color: #f1c40f; color: #333; margin-left: 10px; }
        .message.ai .avatar { background-color: #2c3e50; margin-right: 10px; }

        .bubble {
            padding: 12px 16px; border-radius: 8px; font-size: 0.95rem; line-height: 1.6;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-wrap: break-word;
        }
        .message.user .bubble { background-color: #dcf8c6; color: #000; border-top-right-radius: 0; }
        .message.ai .bubble { background-color: #fff; color: #333; border-top-left-radius: 0; }
        
        /* 简单的Markdown样式支持 */
        .bubble p { margin-bottom: 0.5em; }
        .bubble ul, .bubble ol { margin-left: 20px; margin-bottom: 0.5em; }
        /* 仅针对行内代码设置样式，避免影响代码块高亮 */
        .bubble :not(pre) > code { background: #f0f0f0; padding: 2px 4px; border-radius: 3px; font-family: monospace; }
        /* 代码块不强制背景和颜色，让高亮主题接管样式 */
        .bubble pre { padding: 10px; border-radius: 5px; overflow-x: auto; margin: 10px 0; }
        /* 表格网格线样式（Markdown/HTML 表格） */
        .bubble table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .bubble th, .bubble td { border: 1px solid #e0e0e0; padding: 8px; text-align: left; }
        .bubble thead th { background-color: #f7f9fc; }

        /* 代码块容器与工具栏 */
        .code-block { position: relative; border: 1px solid #e0e0e0; border-radius: 8px; margin: 10px 0; overflow: hidden; }
        .code-block pre { margin: 0; }
        .code-toolbar { position: absolute; top: 6px; right: 8px; display: flex; gap: 6px; z-index: 2; }
        .code-btn {
            padding: 2px 8px; font-size: 12px; border-radius: 6px; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.25);
            background: rgba(255,255,255,0.12);
            color: #e6edf3; /* 适配暗色代码主题 */
        }
        .code-btn:hover { background: rgba(255,255,255,0.22); }
        .code-block.collapsed pre { max-height: 180px; overflow: hidden; }
        .code-block.collapsed::after {
            content: ""; position: absolute; left: 0; right: 0; bottom: 0; height: 40px;
            background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.35));
            pointer-events: none; z-index: 1;
        }

        /* MathJax 公式显示（CHTML 输出） */
        .bubble .mjx-container { margin: 12px 0; }


        .msg-toolbar { margin-top: 8px; display: flex; gap: 8px; }
        .msg-btn {
            padding: 4px 8px; border: 1px solid #ccc; border-radius: 12px;
            background: #fff; font-size: 12px; color: #555; cursor: pointer;
            transition: all 0.2s;
        }
        .msg-btn:hover { background: #f0f0f0; border-color: #bbb; }


        /* 底部输入区 */
        .input-area {
            background: white;
            padding: 15px 30px;
            border-top: 1px solid #ddd;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        /* 功能工具栏 */
        .toolbar {
            display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;
        }
        .tool-btn, .model-select {
            padding: 6px 12px; border: 1px solid #ccc; border-radius: 20px;
            background: #fff; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;
            color: #555;
        }
        .tool-btn:hover, .model-select:hover { background: #f0f0f0; border-color: #bbb; }
        .tool-btn.primary { background-color: #e9f5ff; color: #2c3e50; border-color: #a3d5ff; }
        
        .model-select { min-width: 200px; outline: none; }

        .quick-prompts-panel { margin-top: 8px; display: none; }
        .quick-prompts { display: flex; gap: 8px; flex-wrap: wrap; }
        .quick-btn {
            padding: 6px 12px; border: 2px solid #27ae60; border-radius: 20px;
            background: #f0f0f0; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; color: #2c3e50;
        }
        .quick-btn:hover { border-color: #f1c40f; background: #f0f0f0; }

        /* 输入框行 */
        .input-row { display: flex; gap: 10px; }
        textarea {
            flex: 1; height: 50px; padding: 10px; border: 1px solid #ccc; border-radius: 8px;
            resize: none; font-family: inherit; outline: none;
        }
        textarea:focus { border-color: #2c3e50; box-shadow: 0 0 0 2px rgba(44,62,80,0.1); }
        
        .send-btn {
            width: 80px; background-color: #2c3e50; color: white; border: none;
            border-radius: 8px; cursor: pointer; font-weight: bold; transition: background 0.2s;
        }
        .send-btn:hover { background-color: #34495e; }
        .send-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* 加载动画 */
        .typing-indicator { font-style: italic; color: #888; font-size: 0.8rem; margin-left: 50px; display: none; }

    </style>
    <!-- 引入 Markdown-It 与任务列表插件 -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-task-lists@2.1.1/dist/markdown-it-task-lists.min.js"></script>
    <!-- 代码高亮样式与库 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/dist/highlight.min.js"></script>
    <!-- 使用 MathJax v3 进行 TeX 公式渲染 -->
    <!-- 页面脚本：登录状态、AI 问答逻辑、UI 增强与工具栏 -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            options: {
                renderActions: { addMenu: [] }
            },
            chtml: {
                scale: 1.0
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script" async></script>
    <!-- 让 markdown-it 识别数学表达式并交由 MathJax 渲染 -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-mathjax3@1.1.0/dist/markdown-it-mathjax3.min.js"></script>
</head>
<body>

    <!-- 导航栏 -->
    <nav>
        <ul class="nav-left">
            <li><a href="index.html">首页</a></li>
            <li><a href="./knowledge-graph.html">知识图谱</a></li>
            <li><a href="./aiqa.html" class="active">AI问答</a></li>
            <li><a href="./test.html">知识测试</a></li>
            <li><a href="./resources.html">课程资源</a></li>
        </ul>
        <ul class="nav-right">
            <li class="user-info" id="user-info">
                <a href="./user-center.html" id="user-link">欢迎，<span id="username"></span></a>
            </li>
            <li><a href="javascript:void(0)" onclick="logout()" id="logout-link">退出</a></li>
            <li><a href="./login.html" id="login-link">登录</a></li>
            <li><a href="./register.html" id="register-link">注册</a></li>
        </ul>
    </nav>

    <!-- 主内容区 -->
    <div class="qa-container">
        <!-- 左侧设置与历史 -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3>基本设置</h3>
                <div class="setting-item">
                    <label>OpenRouter API Key</label>
                    <!-- 安全提示：请勿在仓库中保留真实密钥；建议运行时从本地环境、安全存储或浏览器本地存储加载。 -->
                    <!-- 默认填入你提供的 Key -->
                    <input type="password" id="api-key" 
                           value="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">
                </div>
            </div>

            <div class="sidebar-section">
                <h3>历史话题</h3>
                <ul class="history-list">
                    <li class="active">
                        <span class="date">2024-05-22</span>
                        <span class="topic">当前对话</span>
                    </li>
                    <li>
                        <span class="date">2024-05-21</span>
                        <span class="topic">列车运行图编制原理</span>
                    </li>
                    <li>
                        <span class="date">2024-05-20</span>
                        <span class="topic">城市轨道交通客流预测</span>
                    </li>
                </ul>
            </div>
        </aside>

        <!-- 右侧对话区 -->
        <main class="chat-area">
            <div class="chat-log" id="chat-log">
                <!-- 欢迎语 -->
                <div class="message ai">
                    <div class="avatar">AI</div>
                    <div class="bubble">你好！我是轨道交通运营管理课程助手。请选择模型并输入你的问题。</div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typing-indicator">AI 正在思考中...</div>

            <div class="input-area">
                <div class="toolbar">
                    <button class="tool-btn primary" onclick="newTopic()">+ 新建话题</button>
                    
                    <!-- 模型选择下拉菜单 -->
                    <select class="model-select" id="model-select">
                        <option value="google/gemini-2.5-flash">Gemini 2.5 Flash</option>
                        <option value="deepseek/deepseek-r1-0528">DeepSeek R1 0528</option>
                        <option value="deepseek/deepseek-v3.2">DeepSeek V3.2</option>
                    </select>

                    <button class="tool-btn" id="quick-prompts-btn" onclick="toggleQuickPrompts()">常用提示词</button>
                    <button class="tool-btn">上传文档</button>
                    <button class="tool-btn">网络搜索</button>
                    <button class="tool-btn">知识库</button>
                    <button class="tool-btn">知识图谱</button>
                </div>
                <div class="quick-prompts-panel" id="quick-prompts">
                    <div class="quick-prompts">
                        <button class="quick-btn" onclick="insertPrompt('城市轨道交通的类型有哪些？名词不要重复。')">城市轨道交通的类型有哪些？名词不要重复。</button>
                        <button class="quick-btn" onclick="insertPrompt('给出上线车组数的公式，写出行间公式，用字母表示，不要用汉字。')">给出上线车组数的公式，写出行间公式，用字母表示，不要用汉字。</button>
                        <button class="quick-btn" onclick="insertPrompt('已知一条线路的各个车站的上下车人数的dataframe，求断面客流的python代码。')">已知一条线路的各个车站的上下车人数的dataframe，求断面客流的python代码。</button>
                        <button class="quick-btn" onclick="insertPrompt('使用表格总结市域铁路、地铁、城际铁路之间的区别。')">使用表格总结市域铁路、地铁、城际铁路之间的区别。</button>
                    </div>
                </div>
                <div class="input-row">
                    <textarea id="user-input" placeholder="请输入关于轨道交通的问题... (Shift+Enter 换行)"></textarea>
                    <button class="send-btn" id="send-btn" onclick="sendMessage()">发送</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- 1. 登录状态逻辑 (复用 index.html) ---
        function checkLogin() {
            const userInfoStr = localStorage.getItem("userInfo");
            const userInfo = document.getElementById("user-info");
            const logoutLink = document.getElementById("logout-link");
            const loginLink = document.getElementById("login-link");
            const registerLink = document.getElementById("register-link");

            if (userInfoStr) {
                const user = JSON.parse(userInfoStr);
                document.getElementById("username").textContent = user.name;
                userInfo.style.display = "block";
                logoutLink.style.display = "block";
                loginLink.style.display = "none";
                registerLink.style.display = "none";
            } else {
                userInfo.style.display = "none";
                logoutLink.style.display = "none";
                loginLink.style.display = "block";
                registerLink.style.display = "block";
            }
        }
        function logout() {
            localStorage.removeItem("userInfo");
            window.location.reload();
        }
        window.onload = checkLogin;

        // --- 2. AI 问答逻辑 ---
        
        const chatLog = document.getElementById('chat-log');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        const quickPanel = () => document.getElementById('quick-prompts');
        const quickBtn = () => document.getElementById('quick-prompts-btn');
        
        // 存储对话上下文
        let conversationHistory = [];

        // 渲染 Markdown 文本
        function renderMarkdown(md) {
            if (window.markdownit) {
                if (!window.mdParser) {
                    const parser = window.markdownit({ html: true, linkify: true, typographer: true });
                    if (window.markdownitMathjax3) parser.use(window.markdownitMathjax3);
                    if (window.markdownitTaskLists) parser.use(window.markdownitTaskLists, { enabled: true, label: true });
                    window.mdParser = parser;
                }
                return window.mdParser.render(md);
            }
            const esc = s => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            let t = esc(md);
            t = t.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            t = t.replace(/\*(.+?)\*/g, '<em>$1</em>');
            t = t.replace(/`([^`]+)`/g, (_, c) => `<code>${esc(c)}</code>`);
            return t.split(/\r?\n/).map(line => line ? `<p>${line}</p>` : '').join('');
        }

        // 监听回车发送
        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function toggleQuickPrompts() {
            const panel = quickPanel();
            if (!panel) return;
            panel.style.display = panel.style.display === 'none' || panel.style.display === '' ? 'block' : 'none';
        }

        function insertPrompt(text) {
            userInput.value = text;
            const panel = quickPanel();
            if (panel) panel.style.display = 'none';
            userInput.focus();
        }

        document.addEventListener('click', function(e) {
            const panel = quickPanel();
            const btn = quickBtn();
            if (!panel || panel.style.display !== 'block') return;
            if (panel.contains(e.target) || (btn && btn.contains(e.target))) return;
            panel.style.display = 'none';
        });

        // 新建话题
        function newTopic() {
            chatLog.innerHTML = `
                <div class="message ai">
                    <div class="avatar">AI</div>
                    <div class="bubble">话题已重置。请问有什么新问题？</div>
                </div>
            `;
            conversationHistory = [];
            // 重置左侧话题列表 添加时间
            const list = document.querySelector('.history-list');
            if (list) {
                Array.from(list.querySelectorAll('li')).forEach(li => li.classList.remove('active'));
                const li = document.createElement('li');
                li.className = 'active';
                const d = new Date();
                const pad = n => String(n).padStart(2, '0');
                const nowStr = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
                li.innerHTML = `<span class="date">${nowStr}</span><span class="topic">当前对话</span>`;
                list.insertBefore(li, list.firstChild);
            }
        }
        // 代码块与公式增强：MathJax 排版、highlight.js 高亮、折叠/复制工具栏
        function enhanceAIBubble(bubble) {
            const typeset = () => {
                if (window.MathJax && MathJax.typesetPromise) {
                    MathJax.typesetPromise([bubble]).catch(err => console.error(err));
                    return true;
                }
                return false;
            };
            if (!typeset()) {
                setTimeout(typeset, 300);
            }

            const highlight = () => {
                if (window.hljs) {
                    bubble.querySelectorAll('pre code').forEach(block => {
                        window.hljs.highlightElement(block);
                    });
                    return true;
                }
                return false;
            };
            if (!highlight()) {
                setTimeout(highlight, 300);
            }

            const enhanceBlocks = () => {
                const pres = bubble.querySelectorAll('pre');
                pres.forEach(pre => {
                    if (pre.dataset.enhanced === '1') return;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-block';
                    const codeEl = pre.querySelector('code') || pre;
                    const linesCount = (codeEl.textContent.match(/\n/g) || []).length + 1;
                    if (linesCount > 10 || codeEl.textContent.length > 400) {
                        wrapper.classList.add('collapsed');
                    }

                    const toolbar = document.createElement('div');
                    toolbar.className = 'code-toolbar';
                    const collapseBtn = document.createElement('button');
                    collapseBtn.className = 'code-btn';
                    collapseBtn.textContent = wrapper.classList.contains('collapsed') ? '展开' : '缩略';
                    collapseBtn.addEventListener('click', () => {
                        wrapper.classList.toggle('collapsed');
                        collapseBtn.textContent = wrapper.classList.contains('collapsed') ? '展开' : '缩略';
                    });

                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'code-btn';
                    copyBtn.textContent = '复制';
                    copyBtn.addEventListener('click', async () => {
                        try {
                            await navigator.clipboard.writeText(codeEl.textContent);
                            const old = copyBtn.textContent;
                            copyBtn.textContent = '已复制';
                            setTimeout(() => (copyBtn.textContent = old), 1200);
                        } catch (e) {
                            const old = copyBtn.textContent;
                            copyBtn.textContent = '失败';
                            setTimeout(() => (copyBtn.textContent = old), 1200);
                        }
                    });

                    toolbar.appendChild(collapseBtn);
                    toolbar.appendChild(copyBtn);
                    pre.dataset.enhanced = '1';
                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(pre);
                    wrapper.appendChild(toolbar);
                });
            };
            enhanceBlocks();
            setTimeout(enhanceBlocks, 100);
        }

        
        // 消息工具：复制与删除
        function copyMessage(msgDiv) {
            const bubble = msgDiv.querySelector('.bubble');
            if (!bubble) return Promise.resolve();
            const clone = bubble.cloneNode(true);
            clone.querySelectorAll('.msg-toolbar, .code-toolbar').forEach(el => el.remove());
            const text = clone.innerText.trim();
            return navigator.clipboard.writeText(text);
        }

        function deleteMessage(msgDiv) {
            const idxStr = msgDiv.dataset.convIndex;
            const idx = idxStr !== undefined ? parseInt(idxStr, 10) : NaN;
            msgDiv.remove();
            if (isNaN(idx)) return;
            conversationHistory.splice(idx, 1);
            const msgs = Array.from(chatLog.querySelectorAll('.message'));
            msgs.forEach(el => {
                const ci = el.dataset.convIndex;
                if (ci === undefined) return;
                const n = parseInt(ci, 10);
                if (n > idx) el.dataset.convIndex = String(n - 1);
            });
        }

        async function refreshAIMessage(msgDiv) {
            const idxStr = msgDiv.dataset.convIndex;
            const idx = idxStr !== undefined ? parseInt(idxStr, 10) : NaN;
            if (isNaN(idx)) return;
            const apiKey = document.getElementById('api-key').value;
            const model = document.getElementById('model-select').value;
            if (!apiKey) return;
            sendBtn.disabled = true;
            typingIndicator.style.display = 'block';
            try {
                const messages = conversationHistory.slice(0, idx);
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "HTTP-Referer": window.location.href,
                        "X-Title": "RailTransitCourse",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ model, messages })
                });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || "请求失败");
                }
                const data = await response.json();
                const aiReply = data.choices[0].message.content;
                conversationHistory[idx] = { role: "assistant", content: aiReply };
                const bubble = msgDiv.querySelector('.bubble');
                const toolbar = bubble.querySelector('.msg-toolbar');
                bubble.innerHTML = renderMarkdown(aiReply);
                if (toolbar) bubble.appendChild(toolbar);
                enhanceAIBubble(bubble);
            } catch (error) {
                const bubble = msgDiv.querySelector('.bubble');
                bubble.textContent = `刷新失败: ${error.message}`;
            } finally {
                sendBtn.disabled = false;
                typingIndicator.style.display = 'none';
            }
        }
        // 渲染消息：创建头像、气泡与工具栏，并滚动到底部
        function appendMessage(role, text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            const formattedText = role === 'ai' ? renderMarkdown(text) : text.replace(/\n/g, '<br>');

            msgDiv.innerHTML = `
                <div class="avatar">${role === 'user' ? '我' : 'AI'}</div>
                <div class="bubble">${formattedText}</div>
            `;
            chatLog.appendChild(msgDiv);
            const bubble = msgDiv.querySelector('.bubble');
            const toolbar = document.createElement('div');
            toolbar.className = 'msg-toolbar';
            if (role === 'ai') {
                const refreshBtn = document.createElement('button');
                refreshBtn.className = 'msg-btn';
                refreshBtn.textContent = '刷新';
                refreshBtn.addEventListener('click', () => refreshAIMessage(msgDiv));
                const copyBtn = document.createElement('button');
                copyBtn.className = 'msg-btn';
                copyBtn.textContent = '复制';
                copyBtn.addEventListener('click', async () => {
                    try {
                        await copyMessage(msgDiv);
                        copyBtn.textContent = '已复制';
                        setTimeout(() => (copyBtn.textContent = '复制'), 1200);
                    } catch {}
                });
                const delBtn = document.createElement('button');
                delBtn.className = 'msg-btn';
                delBtn.textContent = '删除';
                delBtn.addEventListener('click', () => deleteMessage(msgDiv));
                toolbar.appendChild(refreshBtn);
                toolbar.appendChild(copyBtn);
                toolbar.appendChild(delBtn);
            } else {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'msg-btn';
                copyBtn.textContent = '复制';
                copyBtn.addEventListener('click', async () => {
                    try {
                        await copyMessage(msgDiv);
                        copyBtn.textContent = '已复制';
                        setTimeout(() => (copyBtn.textContent = '复制'), 1200);
                    } catch {}
                });
                const delBtn = document.createElement('button');
                delBtn.className = 'msg-btn';
                delBtn.textContent = '删除';
                delBtn.addEventListener('click', () => deleteMessage(msgDiv));
                toolbar.appendChild(copyBtn);
                toolbar.appendChild(delBtn);
            }
            bubble.appendChild(toolbar);
            if (role === 'ai') {
                enhanceAIBubble(bubble);
            }
            chatLog.scrollTop = chatLog.scrollHeight; // 滚动到底部
            return msgDiv;
        }
        // 发送消息流程：读取输入→校验密钥→维护上下文→调用 OpenRouter→渲染回复
        // 发送消息主函数
        async function sendMessage() {
            const text = userInput.value.trim();
            const apiKey = document.getElementById('api-key').value;
            const model = document.getElementById('model-select').value;

            if (!text) return;
            if (!apiKey) {
                alert("请先在左侧设置中输入 API Key");
                return;
            }

            const userMsgEl = appendMessage('user', text);
            userInput.value = '';
            sendBtn.disabled = true;
            typingIndicator.style.display = 'block';

            if (!conversationHistory.length || conversationHistory[0].role !== "system") {
                conversationHistory.unshift({ role: "system", content: "你是轨道交通领域的专家，能够回答相关专业性问题，语言能够体现专业性和逻辑性。" });
            }
            conversationHistory.push({ role: "user", content: text });
            userMsgEl.dataset.history = '1';
            userMsgEl.dataset.convIndex = String(conversationHistory.length - 1);
            

            try {
                // 3. 调用 OpenRouter API
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "HTTP-Referer": window.location.href, // OpenRouter 要求
                        "X-Title": "RailTransitCourse", // OpenRouter 要求
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": model,
                        "messages": conversationHistory
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || "请求失败");
                }

                const data = await response.json();
                const aiReply = data.choices[0].message.content;

                const aiMsgEl = appendMessage('ai', aiReply);
                
                // 将 AI 回复加入历史上下文
                conversationHistory.push({ role: "assistant", content: aiReply });
                aiMsgEl.dataset.history = '1';
                aiMsgEl.dataset.convIndex = String(conversationHistory.length - 1);

            } catch (error) {
                console.error(error);
                appendMessage('ai', `❌ 出错了: ${error.message}`);
            } finally {
                sendBtn.disabled = false;
                typingIndicator.style.display = 'none';
            }
        }
    </script>
</body>
</html>
