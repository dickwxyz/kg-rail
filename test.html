<!DOCTYPE html>
<!-- 页面：知识测试（城市轨道交通运营管理） -->
<!-- 结构：导航栏 / 标题背景 / 测试内容（试题区域+提交按钮） -->
<!-- 功能：登录检查、获取题目、答案提交与评分 -->
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>知识测试 - 轨道交通运营管理课程</title>
    <!-- 页面样式：全局重置、导航、标题背景、容器、卡片、响应式 -->
    <style>
      /* 全局样式重置 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* 标题背景样式 */
      .header-banner {
        background-image: url(./pic/header-bg.png);
        background-size: 100% auto;
        background-position: center 35%;
        background-repeat: no-repeat;
        padding: 200px 0px; /* 高度稍微减小一些 */
        position: relative;
        overflow: hidden;
        margin: 0 auto;
        width: 100%;
        max-width: 100vw;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header-banner::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.5);
        z-index: 1;
      }

      .header-wrapper {
        position: relative;
        width: 100%;
        background: inherit;
      }

      .header-banner h1 {
        max-width: 800px;
        margin: 0 auto;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        padding: 15px;
        background: rgba(255, 255, 255, 0.85);
        border-radius: 8px;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        background-color: #f9f9f9;
      }

      /* 导航栏样式 */
      nav {
        background-color: #2c3e50;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 10;
      }

      nav ul {
        list-style-type: none;
        display: flex;
        margin: 0;
        padding: 0;
      }

      nav ul li {
        margin-right: 20px;
        display: flex;
        align-items: center;
      }

      nav ul li a {
        color: white;
        text-decoration: none;
        padding: 8px 12px;
        border-radius: 4px;
        transition: background-color 0.3s ease, color 0.3s ease;
        display: inline-block;
        line-height: normal;
      }

      nav ul li a:hover {
        background-color: #34495e;
        color: #f1c40f;
      }

      .nav-right {
        margin-left: auto;
      }

      /* 容器样式 */
      .container {
        padding: 40px 20px 20px;
        max-width: 1200px;
        margin: auto;
      }

      /* 标题样式 */
      h1 {
        font-size: 2.5rem;
        color: #2c3e50;
        margin-bottom: 40px;
        text-align: center;
        position: relative;
        z-index: 2;
      }

      h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 2rem;
        border-bottom: 2px solid #f1c40f;
        display: inline-block;
        padding-bottom: 5px;
      }

      p {
        margin-bottom: 20px;
        color: #555;
      }

      .user-info {
        display: none; /* 默认隐藏用户信息 */
      }

      .user-info a {
        display: inline-block;
        vertical-align: middle;
      }

      .user-info.active {
        display: block; /* 登录后显示 */
      }

      /* 卡片式布局 */
      .card {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      /* 测试相关样式 */
      #test-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .test-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .test-controls {
        display: flex;
        gap: 15px;
      }

      .question-card {
        background-color: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .question-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
      }

      .question-type {
        color: white;
        background-color: #3498db;
        padding: 3px 10px;
        border-radius: 4px;
        font-size: 0.85rem;
      }

      .question-content {
        font-size: 1.1rem;
        margin-bottom: 20px;
      }

      .options-list {
        list-style-type: none;
        padding: 0;
      }

      .option-item {
        padding: 10px 15px;
        margin-bottom: 8px;
        border-radius: 4px;
        background-color: #f7f7f7;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .option-item:hover {
        background-color: #eaf2f8;
      }

      .option-item.selected {
        background-color: #d4e6f1;
        border-left: 4px solid #3498db;
      }

      .blank-answer {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        resize: vertical;
      }

      .essay-answer {
        width: 100%;
        min-height: 150px;
        padding: 10px;
        margin-top: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        resize: vertical;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .btn-primary {
        background-color: #3498db;
        color: white;
      }

      .btn-primary:hover {
        background-color: #2980b9;
      }

      .btn-success {
        background-color: #2ecc71;
        color: white;
      }

      .btn-success:hover {
        background-color: #27ae60;
      }

      .btn-warning {
        background-color: #f1c40f;
        color: #333;
      }

      .btn-warning:hover {
        background-color: #f39c12;
      }

      .btn-danger {
        background-color: #e74c3c;
        color: white;
      }

      .btn-danger:hover {
        background-color: #c0392b;
      }

      #test-results {
        display: none;
      }

      .result-card {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        border-left: 5px solid #3498db;
      }

      .score-display {
        font-size: 2rem;
        font-weight: bold;
        color: #2c3e50;
        text-align: center;
        margin: 20px 0;
      }

      .result-summary {
        display: flex;
        justify-content: space-around;
        margin: 20px 0;
      }

      .result-item {
        text-align: center;
      }

      .result-item .value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #3498db;
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 300px;
      }

      .spinner {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* 响应式设计 */
      @media (max-width: 1200px) {
        nav ul {
          flex-direction: column;
          align-items: center;
        }

        nav ul li {
          margin: 10px 0;
        }

        .header-banner {
          padding: 40px 15px;
          background-position: 65% center;
        }

        .test-info {
          flex-direction: column;
          gap: 15px;
          align-items: flex-start;
        }

        .result-summary {
          flex-direction: column;
          gap: 15px;
        }
      }
    </style>
  </head>
  <body>
    <!-- 导航栏 -->
    <nav>
      <ul class="nav-left">
        <li><a href="index.html">首页</a></li>
        <li><a href="./knowledge-graph.html">知识图谱</a></li>
        <li><a href="./aiqa.html">AI问答</a></li>
        <li><a href="./test.html">知识测试</a></li>
        <li><a href="./resources.html">课程资源</a></li>
      </ul>
      <ul class="nav-right">
        <li class="user-info" id="user-info">
          <a href="./user-center.html" id="user-link">欢迎，<span id="username"></span></a>
        </li>
        <li>
          <a href="javascript:void(0)" onclick="logout()" id="logout-link">退出</a>
        </li>
        <li><a href="./login.html" id="login-link">登录</a></li>
        <li><a href="./register.html" id="register-link">注册</a></li>
      </ul>
    </nav>

    <!-- 标题背景 -->
    <div class="header-wrapper">
      <div class="header-banner">
        <h1>轨道交通运营管理 - 知识测试</h1>
      </div>
    </div>

    <!-- 页面内容容器：测试区域 -->
    <div class="container">
      <!-- 登录提示 -->
      <div id="login-reminder" class="card" style="display: none;">
        <p>请先<a href="./login.html">登录</a>后进行测试。</p>
      </div>

      <!-- 测试容器 -->
      <div id="test-container">
        <!-- 测试信息 -->
        <div class="test-info card">
          <div>
            <h2>测试说明</h2>
            <p>本测试包含单选题、填空题和简答题三种类型，答题完成后点击提交按钮进行评分。</p>
          </div>
          <div class="test-controls">
            <button id="start-test" class="btn btn-primary">开始测试</button>
            <button id="submit-test" class="btn btn-success" disabled>提交答案</button>
          </div>
        </div>

        <!-- 加载指示器 -->
        <div id="loading" class="loading card" style="display: none;">
          <div class="spinner"></div>
        </div>

        <!-- 测试题目区域 -->
        <div id="questions-container"></div>

        <!-- 测试结果区域 -->
        <div id="test-results" class="card">
          <h2>测试结果</h2>
          <div class="score-display">得分: <span id="score">0</span></div>
          <div class="result-summary">
            <div class="result-item">
              <div class="value" id="total-questions">0</div>
              <div class="label">总题数</div>
            </div>
            <div class="result-item">
              <div class="value" id="correct-answers">0</div>
              <div class="label">正确题数</div>
            </div>
            <div class="result-item">
              <div class="value" id="wrong-answers">0</div>
              <div class="label">错误题数</div>
            </div>
          </div>
          <div class="result-actions" style="text-align: center; margin-top: 20px;">
            <button id="retry-btn" class="btn btn-warning">重新测试</button>
            <button id="review-btn" class="btn btn-primary">查看解析</button>
          </div>
        </div>
      </div>

    </div>

    <!-- 页面脚本 -->
    <script>
      // 检查登录状态
      async function checkLogin() {
        try {
          // 从localStorage获取用户信息
          const userInfoStr = localStorage.getItem("userInfo");

          const userInfo = document.getElementById("user-info");
          const logoutLink = document.getElementById("logout-link");
          const loginLink = document.getElementById("login-link");
          const registerLink = document.getElementById("register-link");
          const loginReminder = document.getElementById("login-reminder");
          const testContainer = document.getElementById("test-container");

          if (userInfoStr) {
            // 解析用户信息
            const user = JSON.parse(userInfoStr);

            // 显示用户信息
            document.getElementById("username").textContent = user.name;

            // 更新UI显示状态
            userInfo.style.display = "block";
            logoutLink.style.display = "block";
            loginLink.style.display = "none";
            registerLink.style.display = "none";
            loginReminder.style.display = "none";
            testContainer.style.display = "flex";
          } else {
            // 用户未登录
            userInfo.style.display = "none";
            logoutLink.style.display = "none";
            loginLink.style.display = "block";
            registerLink.style.display = "block";
            loginReminder.style.display = "block";
            testContainer.style.display = "none";
          }
        } catch (error) {
          console.error("检查登录状态失败:", error);
        }
      }

      // 退出功能
      async function logout() {
        // 从localStorage中移除用户信息
        localStorage.removeItem("userInfo");
        // 刷新页面
        window.location.reload();
      }

      // 测试状态变量
      let testState = {
        questions: [],
        userAnswers: {},
        isTestStarted: false,
        isTestSubmitted: false,
        startTime: null
      };

      // 获取测试题目
      async function fetchQuestions() {
        try {
          document.getElementById('loading').style.display = 'flex';

          // 检测是否是通过直接打开文件访问的页面
          if (window.location.protocol === 'file:') {
            throw new Error('请通过服务器访问此页面，启动服务器后访问: http://localhost:5500/test.html');
          }

          // 从localStorage尝试读取上一次的题目
          const savedTest = localStorage.getItem('currentTest');

          if (savedTest) {
            const parsedTest = JSON.parse(savedTest);
            // 检查是否是今天的测试（24小时内的测试）
            const now = new Date();
            const testTime = new Date(parsedTest.startTime);
            const hoursDiff = (now - testTime) / (1000 * 60 * 60);

            if (hoursDiff < 24) {
              console.log('从缓存读取测试题目');
              testState.questions = parsedTest.questions;
              testState.userAnswers = parsedTest.userAnswers || {};
              testState.startTime = parsedTest.startTime;

              document.getElementById('loading').style.display = 'none';
              renderQuestions(testState.questions);
              document.getElementById('submit-test').disabled = false;
              return;
            } else {
              // 超过24小时，清除旧测试
              localStorage.removeItem('currentTest');
            }
          }

          // 没有缓存或缓存过期，请求新题目
          const response = await fetch('/api/questions', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            throw new Error('获取题目失败');
          }

          const data = await response.json();
          if (!data.success) {
            throw new Error(data.message || '获取题目失败');
          }

          testState.questions = data.questions;
          testState.startTime = new Date().toISOString();

          // 保存到localStorage
          saveTestToLocalStorage();

          document.getElementById('loading').style.display = 'none';
          renderQuestions(testState.questions);
          document.getElementById('submit-test').disabled = false;
        } catch (error) {
          console.error('获取题目出错:', error);
          document.getElementById('loading').style.display = 'none';

          // 显示更友好的错误信息
          const errorMessage = error.message.includes('服务器访问')
            ? `
              <h3 style="color: #e74c3c;">请通过服务器访问此页面</h3>
              <p>当前错误: 无法连接到API服务器</p>
              <p>解决方法:</p>
              <ol>
                <li>确保您已经启动了Node.js服务器 (运行 <code>node server.js</code> 或 <code>npm start</code>)</li>
                <li>通过服务器访问此页面: <a href="http://localhost:5500/test.html">http://localhost:5500/test.html</a></li>
              </ol>
              <p>直接打开HTML文件无法正常工作，因为浏览器安全策略会阻止API请求。</p>
            `
            : `<p style="color: red;">获取题目失败，请稍后重试。</p><p>${error.message}</p>`;

          document.getElementById('questions-container').innerHTML = `
            <div class="card">
              ${errorMessage}
            </div>
          `;
        }
      }

      // 保存测试状态到localStorage
      function saveTestToLocalStorage() {
        localStorage.setItem('currentTest', JSON.stringify({
          questions: testState.questions,
          userAnswers: testState.userAnswers,
          startTime: testState.startTime,
          isTestStarted: testState.isTestStarted
        }));
      }

      // 渲染测试题目
      function renderQuestions(questions) {
        const container = document.getElementById('questions-container');
        container.innerHTML = '';

        questions.forEach((question, index) => {
          const questionElement = document.createElement('div');
          questionElement.className = 'question-card';
          questionElement.id = `question-${question.id}`;

          let questionType;
          switch(question.type) {
            case '单选题':
              questionType = '单选题';
              break;
            case '填空题':
              questionType = '填空题';
              break;
            case '简答题':
              questionType = '简答题';
              break;
            case '计算题':
              questionType = '计算题';
              break;
            default:
              questionType = question.type;
          }

          // 题目标题和类型
          questionElement.innerHTML = `
            <div class="question-header">
              <div class="question-number">第 ${index + 1} 题</div>
              <div class="question-type">${questionType}</div>
            </div>
            <div class="question-content">${question.question}</div>
          `;

          // 根据题型渲染不同的答题区域
          if (question.type === '单选题') {
            renderChoiceQuestion(questionElement, question);
          } else if (question.type === '填空题') {
            renderFillBlankQuestion(questionElement, question);
          } else if (question.type === '简答题' || question.type === '计算题') {
            renderEssayQuestion(questionElement, question);
          }

          container.appendChild(questionElement);
        });
      }

      // 渲染单选题
      function renderChoiceQuestion(element, question) {
        const options = JSON.parse(question.options);
        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'options-container';

        const optionsList = document.createElement('ul');
        optionsList.className = 'options-list';

        // 获取已保存的用户答案
        const savedAnswer = testState.userAnswers[question.id];

        // 遍历选项
        for (const [key, value] of Object.entries(options)) {
          const optionItem = document.createElement('li');
          optionItem.className = 'option-item';
          optionItem.dataset.value = key;
          optionItem.textContent = `${key}. ${value}`;

          // 如果已有保存的答案，标记为选中状态
          if (savedAnswer && savedAnswer === key) {
            optionItem.classList.add('selected');
          }

          // 点击选项的事件处理
          optionItem.addEventListener('click', function() {
            // 清除同级选项的选中状态
            const siblingOptions = this.parentElement.querySelectorAll('.option-item');
            siblingOptions.forEach(option => option.classList.remove('selected'));

            // 设置当前选项为选中状态
            this.classList.add('selected');

            // 保存用户答案
            testState.userAnswers[question.id] = key;

            // 保存到localStorage
            saveTestToLocalStorage();
          });

          optionsList.appendChild(optionItem);
        }

        optionsContainer.appendChild(optionsList);
        element.appendChild(optionsContainer);
      }

      // 渲染填空题
      function renderFillBlankQuestion(element, question) {
        const answerContainer = document.createElement('div');
        answerContainer.className = 'answer-container';

        const textArea = document.createElement('textarea');
        textArea.className = 'blank-answer';
        textArea.placeholder = '请在此输入您的答案...';

        // 输入事件
        textArea.addEventListener('input', function() {
          testState.userAnswers[question.id] = this.value;
          saveTestToLocalStorage();
        });

        // 如果已有答案，则填充
        if (testState.userAnswers[question.id]) {
          textArea.value = testState.userAnswers[question.id];
        }

        answerContainer.appendChild(textArea);
        element.appendChild(answerContainer);
      }

      // 渲染简答题
      function renderEssayQuestion(element, question) {
        const answerContainer = document.createElement('div');
        answerContainer.className = 'answer-container';

        const textArea = document.createElement('textarea');
        textArea.className = 'essay-answer';
        textArea.placeholder = '请在此输入您的答案...';

        // 输入事件
        textArea.addEventListener('input', function() {
          testState.userAnswers[question.id] = this.value;
          saveTestToLocalStorage();
        });

        // 如果已有答案，则填充
        if (testState.userAnswers[question.id]) {
          textArea.value = testState.userAnswers[question.id];
        }

        answerContainer.appendChild(textArea);
        element.appendChild(answerContainer);
      }

      // 提交测试答案
      async function submitTest() {
        try {
          const userInfo = JSON.parse(localStorage.getItem('userInfo'));

          if (!userInfo) {
            alert('请先登录后提交测试');
            return;
          }

          // 检查是否有答案要提交
          const answerCount = Object.keys(testState.userAnswers).length;
          if (answerCount === 0) {
            alert('请至少回答一题后再提交！');
            return;
          }

          document.getElementById('loading').style.display = 'flex';
          document.getElementById('submit-test').disabled = true;

          const response = await fetch('/api/submit-test', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              userId: userInfo.id,
              userType: userInfo.role, // 使用正确的角色字段
              answers: testState.userAnswers
            })
          });

          if (!response.ok) {
            throw new Error('提交答案失败');
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message || '提交答案失败');
          }

          // 提交成功后清除本地缓存的测试
          localStorage.removeItem('currentTest');

          document.getElementById('loading').style.display = 'none';
          displayTestResults(result);

          testState.isTestSubmitted = true;

        } catch (error) {
          console.error('提交测试出错:', error);
          document.getElementById('loading').style.display = 'none';
          document.getElementById('submit-test').disabled = false;
          alert('提交答案失败，请稍后重试: ' + error.message);
        }
      }

      // 显示测试结果
      function displayTestResults(result) {
        document.getElementById('questions-container').style.display = 'none';
        document.getElementById('test-results').style.display = 'block';

        // 更新测试结果信息
        document.getElementById('score').textContent = result.score;
        document.getElementById('total-questions').textContent = result.totalQuestions;
        document.getElementById('correct-answers').textContent = result.correctCount;
        document.getElementById('wrong-answers').textContent = result.wrongCount;

        // 显示测试ID，便于教师查询
        const resultHeader = document.querySelector('#test-results h2');
        resultHeader.innerHTML = `测试结果 <span style="font-size: 0.8rem; color: #777;">(测试ID: ${result.testId})</span>`;
      }

      // 重新测试
      function restartTest() {
        // 清除localStorage中保存的测试
        localStorage.removeItem('currentTest');

        // 重置测试状态
        testState = {
          questions: [],
          userAnswers: {},
          isTestStarted: false,
          isTestSubmitted: false,
          startTime: null
        };

        // 重置UI
        document.getElementById('questions-container').innerHTML = '';
        document.getElementById('questions-container').style.display = 'block';
        document.getElementById('test-results').style.display = 'none';
        document.getElementById('submit-test').disabled = true;

        // 获取新题目
        fetchQuestions();
      }

      // 事件监听器
      document.addEventListener('DOMContentLoaded', function() {
        // 检查登录状态
        checkLogin();

        // 开始测试按钮
        document.getElementById('start-test').addEventListener('click', function() {
          if (!testState.isTestStarted) {
            testState.isTestStarted = true;
            this.textContent = '重新开始';
            fetchQuestions();
          } else {
            if (confirm('确定要重新开始测试吗？当前进度将会丢失。')) {
              restartTest();
            }
          }
        });

        // 提交测试按钮
        document.getElementById('submit-test').addEventListener('click', function() {
          // 检查是否至少回答了一题
          const answeredCount = Object.keys(testState.userAnswers).length;

          if (answeredCount === 0) {
            alert('请至少回答一题后再提交！');
            return;
          }

          if (confirm('确定要提交测试吗？提交后将无法修改答案。')) {
            submitTest();
          }
        });

        // 重新测试按钮
        document.getElementById('retry-btn').addEventListener('click', function() {
          restartTest();
        });

        // 查看解析按钮
        document.getElementById('review-btn').addEventListener('click', function() {
          // 此功能可以后续实现
          alert('解析功能正在开发中，敬请期待！');
        });
      });
    </script>
  </body>
</html>